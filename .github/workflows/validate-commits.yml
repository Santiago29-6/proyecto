name: Validate all commit messages

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  validate-commit-messages:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Trae todo el historial

      - name: Ensure full history (in case of shallow clones)
        run: |
          git fetch --unshallow || true
          git fetch --all

      - name: Get and validate commit messages
        run: |
          echo "üîç Getting commit messages..."

          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_BRANCH=${{ github.event.pull_request.base.ref }}
            git fetch origin "$BASE_BRANCH"
            RANGE="origin/$BASE_BRANCH..HEAD"
          else
            RANGE="${{ github.event.before }}..${{ github.sha }}"
          fi

          # Validar que el rango sea v√°lido
          if ! git rev-list "$RANGE" >/dev/null 2>&1; then
            echo "‚ö†Ô∏è Commit range '$RANGE' is not valid (possibly due to missing history). Skipping validation."
            exit 0
          fi

          COMMITS=$(git log --pretty=%s $RANGE)

          echo "$COMMITS" | while IFS= read -r COMMIT_MESSAGE; do
            echo "‚û°Ô∏è Commit: '$COMMIT_MESSAGE'"

            if [[ "$COMMIT_MESSAGE" =~ ^Merge ]]; then
              echo "‚ÑπÔ∏è Skipping merge commit."
              continue
            fi

            if [[ ! "$COMMIT_MESSAGE" =~ ^[0-9]{3}\ \((feat|fix|test|refactor)\):\ .+ ]]; then
              echo "‚ùå Invalid commit message: '$COMMIT_MESSAGE'"
              echo "‚úÖ Expected format: 'NNN (type): descriptive message'"
              echo "üîí Push has been blocked."
              exit 1
            fi
          done

          echo "‚úÖ All commit messages are valid."
